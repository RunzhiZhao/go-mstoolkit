# Redis åˆ†å¸ƒå¼é”è¡Œä¸ºè¯´æ˜

## ğŸ”§ ä¿®æ”¹åçš„é”æ–¹æ³•è¡Œä¸º

### 1. `Lock(ctx, key)` - é˜»å¡å¼ï¼ˆé»˜è®¤è¶…æ—¶ï¼‰
```go
unlock, err := locker.Lock(ctx, "user123")
```
- **è¡Œä¸º**: é˜»å¡ç­‰å¾…ï¼Œä½¿ç”¨é»˜è®¤è¶…æ—¶æ—¶é—´ï¼ˆ30ç§’ï¼‰
- **ä½¿ç”¨åœºæ™¯**: å…³é”®ä¸šåŠ¡æ“ä½œï¼Œç”¨æˆ·æœŸæœ›ç­‰å¾…çš„åœºæ™¯  
- **é€‚ç”¨äº**: è´­ä¹°å•†å“ã€æ”¯ä»˜å¤„ç†ã€è´¦æˆ·æ“ä½œ

### 2. `TryLock(ctx, key)` - éé˜»å¡ï¼ˆç«‹å³è¿”å›ï¼‰
```go
unlock, err := locker.TryLock(ctx, "user123")
if unlock == nil {
    // æœªè·å–åˆ°é”ï¼Œä½†ä¸æ˜¯é”™è¯¯
    return
}
```
- **è¡Œä¸º**: ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…
- **ä½¿ç”¨åœºæ™¯**: å¯é€‰æ“ä½œï¼Œæ€§èƒ½æ•æ„Ÿçš„åœºæ™¯
- **é€‚ç”¨äº**: ç‚¹èµã€è¯„è®ºã€ç»Ÿè®¡ã€ç¼“å­˜æ›´æ–°

### 3. `LockWithTimeout(ctx, key, timeout)` - é˜»å¡å¼ï¼ˆè‡ªå®šä¹‰è¶…æ—¶ï¼‰
```go
unlock, err := locker.LockWithTimeout(ctx, "user123", 60*time.Second)
```
- **è¡Œä¸º**: é˜»å¡ç­‰å¾…ï¼Œä½¿ç”¨è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´
- **ä½¿ç”¨åœºæ™¯**: éœ€è¦ç‰¹æ®Šè¶…æ—¶è®¾ç½®çš„åœºæ™¯
- **é€‚ç”¨äº**: VIPæœåŠ¡ã€é•¿æ—¶é—´æ“ä½œã€ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚

## ğŸ“Š è¡Œä¸ºå¯¹æ¯”è¡¨

| æ–¹æ³• | é˜»å¡æ€§ | è¶…æ—¶æ—¶é—´ | è¿”å›æ—¶æœº | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|----------|----------|
| `Lock` | âœ… é˜»å¡ | é»˜è®¤30ç§’ | è·å–åˆ°é”æˆ–è¶…æ—¶ | å…³é”®ä¸šåŠ¡æ“ä½œ |
| `TryLock` | âŒ éé˜»å¡ | æ— è¶…æ—¶ | ç«‹å³è¿”å› | å¯é€‰æ“ä½œ |
| `LockWithTimeout` | âœ… é˜»å¡ | è‡ªå®šä¹‰ | è·å–åˆ°é”æˆ–è¶…æ—¶ | ç‰¹æ®Šè¶…æ—¶éœ€æ±‚ |

## ğŸ¯ ä½¿ç”¨å»ºè®®

### âœ… æ¨èä½¿ç”¨åœºæ™¯

**Lockï¼ˆé˜»å¡å¼ï¼‰**
```go
// è´­ä¹°å•†å“ - ç”¨æˆ·æœŸæœ›ç­‰å¾…
unlock, err := locker.Lock(ctx, fmt.Sprintf("buy:%s", userID))
if err != nil {
    return fmt.Errorf("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
}
defer unlock(ctx)
```

**TryLockï¼ˆéé˜»å¡ï¼‰**
```go
// ç‚¹èµæ“ä½œ - ç«‹å³åé¦ˆ
unlock, err := locker.TryLock(ctx, fmt.Sprintf("like:%s", userID))
if unlock == nil {
    return fmt.Errorf("ç‚¹èµå¤ªé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•")
}
defer unlock(ctx)
```

**LockWithTimeoutï¼ˆè‡ªå®šä¹‰è¶…æ—¶ï¼‰**
```go
// VIPè´­ä¹° - æ›´é•¿ç­‰å¾…æ—¶é—´
unlock, err := locker.LockWithTimeout(ctx, fmt.Sprintf("vip:%s", userID), 60*time.Second)
if err != nil {
    return fmt.Errorf("VIPæœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
}
defer unlock(ctx)
```

## ğŸ”„ è¿ç§»æŒ‡å—

å¦‚æœæ‚¨ä¹‹å‰ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬çš„éé˜»å¡ `Lock`ï¼š

```go
// æ—§ç‰ˆæœ¬ï¼ˆéé˜»å¡ï¼‰
unlock, err := locker.Lock(ctx, key)
if err != nil {
    // ç«‹å³å¤±è´¥
    return err
}

// æ–°ç‰ˆæœ¬ - é€‰æ‹©åˆé€‚çš„æ–¹æ³•ï¼š

// 1. å¦‚æœå¸Œæœ›ç­‰å¾… â†’ ä½¿ç”¨æ–°çš„ Lockï¼ˆé˜»å¡å¼ï¼‰
unlock, err := locker.Lock(ctx, key)

// 2. å¦‚æœå¸Œæœ›ç«‹å³è¿”å› â†’ ä½¿ç”¨ TryLock
unlock, err := locker.TryLock(ctx, key)
if unlock == nil {
    // æœªè·å–åˆ°é”
    return 
}

// 3. å¦‚æœéœ€è¦è‡ªå®šä¹‰è¶…æ—¶ â†’ ä½¿ç”¨ LockWithTimeout
unlock, err := locker.LockWithTimeout(ctx, key, 10*time.Second)
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é‡‘é’±ç›¸å…³æ“ä½œ** â†’ ä½¿ç”¨ `Lock` æˆ– `LockWithTimeout`
2. **ç”¨æˆ·ä½“éªŒå…³é”®æ“ä½œ** â†’ ä½¿ç”¨ `Lock`
3. **å¯é€‰åŠŸèƒ½** â†’ ä½¿ç”¨ `TryLock`
4. **é«˜é¢‘æ“ä½œ** â†’ ä½¿ç”¨ `TryLock`
5. **ç‰¹æ®Šè¶…æ—¶éœ€æ±‚** â†’ ä½¿ç”¨ `LockWithTimeout`

è®°ä½ï¼š**å®å¯è®©ç”¨æˆ·ç­‰å¾…å‡ ç§’é’Ÿï¼Œä¹Ÿä¸è¦è®©ç”¨æˆ·æ”¶åˆ°è«åå…¶å¦™çš„å¤±è´¥ä¿¡æ¯ï¼** ğŸ¯